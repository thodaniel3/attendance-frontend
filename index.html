<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>MME Attendance Management System</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>

<style>
body{font-family:Arial,sans-serif;background:#000;color:#f5f5f5;margin:0;padding:0}
h1,h2,h3{text-align:center;margin-top:20px;color:#d4af37;font-weight:bold}
.container{max-width:900px;margin:0 auto;padding:20px}
section{background:#111;padding:20px;border-radius:10px;margin-bottom:25px;border:1px solid #333;box-shadow:0 0 10px rgba(212,175,55,0.15)}
input,button{width:95%;padding:12px;margin-top:10px;margin-bottom:10px;border-radius:6px;border:none;font-size:16px}
input{background:#222;color:#ddd;border:1px solid #444}
button{background:#5c3a23;color:white;cursor:pointer;font-weight:bold}
button:hover{background:#7a4d2d}
#scan-overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center}
#scan-overlay .overlay-card{background:#111;padding:18px;border-radius:10px;border:1px solid #333;text-align:center;width:100%;max-width:420px}
#scan-overlay img{max-width:150px;border-radius:10px;border:2px solid #333;margin-bottom:10px}
#scan-overlay input{width:100%;padding:10px;border-radius:6px;margin-top:8px}
.button-row{display:flex;gap:10px}
.notice-box{background:#111;border-left:4px solid #d4af37;padding:14px;margin:20px 0;border-radius:6px}
</style>
</head>

<body>

<h1>MME Attendance Management System</h1>

<div class="container">

<section id="register">
<h2>Student Registration</h2>

<form id="regForm" enctype="multipart/form-data">
<input name="name" placeholder="Full Name" required>
<input name="username" placeholder="Username" required>
<input name="email" type="email" placeholder="Email" required>
<input name="matric_number" placeholder="Matric Number" required>
<input id="photo" name="photo" type="file" accept="image/*" required>
<button type="submit">Register & Download QR</button>
</form>

<div id="regResult"></div>

<div id="student-panel" style="display:none">
<img id="profile-photo">
<div>Name: <span id="profile-name"></span></div>
<div>Matric: <span id="profile-matric"></span></div>
<div>Email: <span id="profile-email"></span></div>
<img id="profile-qr">
</div>
</section>

<div class="notice-box">
<strong>Important:</strong> Present QR code daily for attendance
</div>

<h2>QR Scanner</h2>
<button onclick="window.location.href='scanner.html'">Open Scanner</button>

</div>

<script>
const API_URL="https://attendance-backend-6tmr.onrender.com/api";

// REGISTRATION
document.getElementById("regForm").addEventListener("submit",async e=>{
e.preventDefault();
const form=new FormData(e.target);
const res=await fetch(API_URL+"/student",{method:"POST",body:form});
const data=await res.json();
if(!data.ok){alert("Registration failed");return;}
document.getElementById("student-panel").style.display="block";
document.getElementById("profile-name").textContent=data.student.name;
document.getElementById("profile-matric").textContent=data.student.matric_number;
document.getElementById("profile-email").textContent=data.student.email;
document.getElementById("profile-photo").src=data.student.photo_url;
document.getElementById("profile-qr").src=data.student.qr_code_url;
});

// REMEMBER HELPERS
function saveToday(k,v){localStorage.setItem(k,v);localStorage.setItem(k+"_date",new Date().toISOString().slice(0,10))}
function loadToday(k){return localStorage.getItem(k+"_date")==new Date().toISOString().slice(0,10)?localStorage.getItem(k):null}

// ATTENDANCE OVERLAY
async function showConfirmAndPost(studentId){
const overlay=document.createElement("div");
overlay.id="scan-overlay";
overlay.innerHTML=`
<div class="overlay-card">
<img id="student-photo">
<div id="student-name"></div>
<div id="student-matric"></div>
<input id="scan-lecturer" placeholder="Lecturer Name">
<input id="scan-course" placeholder="Course Code">
<input id="scan-pin" placeholder="PIN" type="password">
<label><input id="scan-remember" type="checkbox"> Remember today</label>
<div class="button-row">
<button id="scan-submit">Submit</button>
<button id="scan-cancel">Cancel</button>
</div>
<p id="scan-result"></p>
</div>`;
document.body.appendChild(overlay);

const r=await fetch(API_URL+"/student/"+studentId);
const s=(await r.json()).student;
document.getElementById("student-photo").src=s.photo_url;
document.getElementById("student-name").textContent=s.name;
document.getElementById("student-matric").textContent=s.matric_number;

document.getElementById("scan-cancel").onclick=()=>overlay.remove();

document.getElementById("scan-submit").onclick=async()=>{
const pin=document.getElementById("scan-pin").value;
const lecturer=document.getElementById("scan-lecturer").value;
const course=document.getElementById("scan-course").value;
const remember=document.getElementById("scan-remember").checked;

const res=await fetch(API_URL+"/attendance",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({student_id:studentId,lecturer,course,admin_pin:pin})
});
const data=await res.json();

if(data.ok){
document.getElementById("scan-result").textContent="✅ Attendance recorded";
if(remember){
saveToday("lecturer_pin",pin);
saveToday("lecturer_name",lecturer);
saveToday("course_code",course);
}

/* ✅ ONLY FIX — REDIRECT TO SCANNER */
setTimeout(()=>{
overlay.remove();
window.location.href="scanner.html";
},900);

}else{
document.getElementById("scan-result").textContent=data.error;
}
};
}

window.addEventListener("DOMContentLoaded",()=>{
const id=new URLSearchParams(window.location.search).get("id");
if(id) showConfirmAndPost(id);
});
</script>

</body>
</html>
