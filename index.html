<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Attendance App</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body { font-family: Arial,sans-serif; background:#000; color:#f5f5f5; margin:0; padding:0; }
h1,h2,h3 { text-align:center; margin-top:20px; color:#d4af37; font-weight:bold; }
.container { max-width:900px; margin:0 auto; padding:20px; }
section { background:#111; padding:20px; border-radius:10px; margin-bottom:25px; border:1px solid #333; box-shadow:0 0 10px rgba(212,175,55,0.15); }
input,button { width:100%; padding:12px; margin-top:10px; margin-bottom:10px; border-radius:6px; border:none; font-size:16px; }
input { background:#222; color:#ddd; border:1px solid #444; }
button { background:#5c3a23; color:white; cursor:pointer; font-weight:bold; transition:0.3s ease; }
button:hover { background:#7a4d2d; }
#student-panel img,#profile-photo,#profile-qr { border-radius:10px; margin-top:10px; border:2px solid #333; }
#regResult,#scanResult { margin-top:12px; padding:10px; background:#222; border-radius:6px; border:1px solid #333; }
</style>
</head>
<body>

<h1>Attendance Management System</h1>
<div class="container">

  <!-- Registration -->
  <section id="register">
    <h2>Student Registration</h2>
    <form id="regForm" enctype="multipart/form-data">
      <input name="name" placeholder="Full Name" required>
      <input name="username" placeholder="Username" required>
      <input name="email" type="email" placeholder="Email" required>
      <input name="matric_number" placeholder="Matric Number" required>
      <label>Upload Passport Photograph:</label>
      <input id="photo" name="photo" type="file" accept="image/*" required>
      <button type="submit">Register & Download QR</button>
    </form>
    <div id="regResult"></div>

    <div id="student-panel" style="display:none;">
      <h3>Student Profile</h3>
      <img id="profile-photo" style="max-width:150px;">
      <div>Name: <span id="profile-name"></span></div>
      <div>Matric: <span id="profile-matric"></span></div>
      <div>Email: <span id="profile-email"></span></div>
      <h3>QR Code</h3>
      <img id="profile-qr" style="max-width:200px;">
    </div>
  </section>
</div>

<script>
const API_URL = "https://attendance-backend-6tmr.onrender.com/api";

// display messages
function info(msg) { document.getElementById("regResult").textContent = msg; }

// download QR
async function fetchAndDownload(url, filename){
  const res = await fetch(url);
  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

// Registration
document.getElementById('regForm')?.addEventListener('submit', async e=>{
  e.preventDefault();
  const name = document.querySelector('[name="name"]').value.trim();
  const username = document.querySelector('[name="username"]').value.trim();
  const email = document.querySelector('[name="email"]').value.trim();
  const matric_number = document.querySelector('[name="matric_number"]').value.trim();
  const photo = document.getElementById("photo").files[0];
  if(!name||!username||!email||!matric_number||!photo) return alert("All fields required");

  const form = new FormData();
  form.append("name",name);
  form.append("username",username);
  form.append("email",email);
  form.append("matric_number",matric_number);
  form.append("photo",photo);

  info("Sending registration...");
  try {
    const res = await fetch(`${API_URL}/student`,{method:"POST",body:form});
    let data = await res.json();
    if(!res.ok||!data.ok){ alert("Failed: "+data.error); return; }

    const student = data.student;
    document.getElementById("student-panel").style.display="block";
    document.getElementById("profile-name").textContent=student.name;
    document.getElementById("profile-matric").textContent=student.matric_number;
    document.getElementById("profile-email").textContent=student.email;
    document.getElementById("profile-photo").src=student.photo_url||'';
    document.getElementById("profile-qr").src=student.qr_code_url||'';
    if(student.qr_code_url) fetchAndDownload(student.qr_code_url,`${student.name}_QR.png`);
    info("Registration Complete!");
  } catch(err){ alert("Error: "+err.message); info("Failed"); }
});

// Scan via URL
function getQueryParam(name){ return new URL(window.location.href).searchParams.get(name); }
function getSavedPin(){ 
  const pin=localStorage.getItem('lecturer_pin'); 
  const date=localStorage.getItem('lecturer_pin_date'); 
  if(!pin||!date) return null; 
  return date===new Date().toISOString().slice(0,10)?pin:null;
}
function savePinForToday(pin){ localStorage.setItem('lecturer_pin',pin); localStorage.setItem('lecturer_pin_date',new Date().toISOString().slice(0,10)); }

async function postAttendance(studentId, lecturerName, courseCode, pin){
  const res = await fetch(`${API_URL}/attendance`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({student_id:studentId, lecturer:lecturerName, course:courseCode, admin_pin:pin})
  });
  return await res.json();
}

function createScanUi(studentId){
  document.body.style.filter='blur(2px)';
  const overlay=document.createElement('div');
  overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0;
  overlay.style.background='rgba(0,0,0,0.85)'; overlay.style.zIndex=9999;
  overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
  overlay.style.padding='20px';
  overlay.innerHTML=`
    <div style="max-width:420px;width:100%;background:#111;padding:18px;border-radius:10px;border:1px solid #333;color:#fff;">
      <h3 style="margin-top:0;text-align:center;color:#d4af37">Confirm Attendance</h3>
      <p id="scan-msg">Student ID: <strong>${studentId}</strong></p>
      <input id="scan-lecturer" placeholder="Lecturer Name" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #444;background:#222;color:#ddd">
      <input id="scan-course" placeholder="Course Code" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #444;background:#222;color:#ddd">
      <input id="scan-pin" placeholder="Enter secret PIN" type="password" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #444;background:#222;color:#ddd">
      <label style="display:flex;align-items:center;margin-top:8px;color:#ddd">
        <input id="scan-remember" type="checkbox" style="margin-right:8px"> Remember PIN for today
      </label>
      <div style="display:flex;gap:8px;margin-top:12px;">
        <button id="scan-submit" style="flex:1;padding:10px;background:#5c3a23;border-radius:6px;border:none;color:#fff;cursor:pointer">Submit</button>
        <button id="scan-cancel" style="flex:1;padding:10px;background:#444;border-radius:6px;border:none;color:#fff;cursor:pointer">Cancel</button>
      </div>
      <p id="scan-result" style="margin-top:12px;color:#ddd"></p>
    </div>
  `;
  document.body.appendChild(overlay);

  const savedPin=getSavedPin();
  if(savedPin){ document.getElementById('scan-pin').value=savedPin; document.getElementById('scan-remember').checked=true; }

  document.getElementById('scan-cancel').addEventListener('click',()=>{ overlay.remove(); document.body.style.filter=''; });
  document.getElementById('scan-submit').addEventListener('click', async ()=>{
    const pin=document.getElementById('scan-pin').value.trim();
    const lecturer=document.getElementById('scan-lecturer').value.trim();
    const course=document.getElementById('scan-course').value.trim();
    const remember=document.getElementById('scan-remember').checked;
    const resultBox=document.getElementById('scan-result');
    if(!pin){ resultBox.textContent='Please enter PIN.'; return; }
    resultBox.textContent='Submitting...';
    const res=await postAttendance(studentId,lecturer,course,pin);
    if(res.ok){ resultBox.textContent='âœ… Attendance recorded.';
      if(remember){ savePinForToday(pin); if(lecturer) localStorage.setItem('lecturer_name',lecturer); }
      setTimeout(()=>{ overlay.remove(); document.body.style.filter=''; },900);
    } else { resultBox.textContent='Error: '+(res.error||'Failed'); }
  });
}

window.addEventListener('DOMContentLoaded',()=>{
  const studentId=getQueryParam('id');
  if(studentId) createScanUi(studentId);
});
</script>

</body>
</html>
